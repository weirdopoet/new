"use client";
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { CopyIcon } from "@radix-ui/react-icons";
import { useQuery } from "@tanstack/react-query";
import { useCallback } from "react";
import { defineChain, getCachedChain, getChainMetadata, } from "../../../../../chains/utils.js";
import { shortenHex } from "../../../../../utils/address.js";
import { formatExplorerTxUrl } from "../../../../../utils/url.js";
import { useCustomTheme } from "../../../../core/design-system/CustomThemeProvider.js";
import { iconSize, radius, spacing, } from "../../../../core/design-system/index.js";
import { formatTokenAmount } from "../../ConnectWallet/screens/formatTokenBalance.js";
import { Container, ModalHeader } from "../../components/basic.js";
import { shorterChainName } from "../../components/ChainName.js";
import { Skeleton } from "../../components/Skeleton.js";
import { Spacer } from "../../components/Spacer.js";
import { Text } from "../../components/text.js";
function getPaymentId(preparedQuote, status) {
    if (preparedQuote.type === "onramp") {
        return preparedQuote.id;
    }
    return status.transactions[status.transactions.length - 1]?.transactionHash;
}
/**
 * Hook to fetch transaction info for a completed status
 */
function useTransactionInfo(status, preparedQuote) {
    return useQuery({
        enabled: true,
        queryFn: async () => {
            const isOnramp = status.type === "onramp";
            if (isOnramp && preparedQuote.type === "onramp") {
                // For onramp, create a display ID since OnrampStatus doesn't have paymentId
                return {
                    amountPaid: `${preparedQuote.currencyAmount} ${preparedQuote.currency}`,
                    amountReceived: `${formatTokenAmount(preparedQuote.destinationAmount, preparedQuote.destinationToken.decimals)} ${preparedQuote.destinationToken.symbol}`,
                    chain: await getChainMetadata(defineChain(preparedQuote.destinationToken.chainId)),
                    destinationToken: preparedQuote.destinationToken,
                    id: preparedQuote.id,
                    label: "Onramp Payment",
                    type: "paymentId",
                };
            }
            else if (status.type === "buy" ||
                status.type === "sell" ||
                status.type === "transfer") {
                if (status.transactions.length > 0) {
                    // get the last transaction hash
                    const tx = status.transactions[status.transactions.length - 1];
                    if (tx) {
                        const [destinationChain, originChain] = await Promise.all([
                            getChainMetadata(getCachedChain(status.destinationToken.chainId)),
                            getChainMetadata(getCachedChain(status.originToken.chainId)),
                        ]);
                        return {
                            amountPaid: `${formatTokenAmount(status.originAmount, status.originToken.decimals)} ${status.originToken.symbol}`,
                            amountReceived: `${formatTokenAmount(status.destinationAmount, status.destinationToken.decimals)} ${status.destinationToken.symbol}`,
                            chain: destinationChain,
                            destinationChain,
                            destinationToken: status.destinationToken,
                            id: tx.transactionHash,
                            label: "Transaction",
                            originChain,
                            originToken: status.originToken,
                            type: "transactionHash",
                        };
                    }
                }
            }
            return null;
        },
        queryKey: [
            "transaction-info",
            status.type,
            getPaymentId(preparedQuote, status),
        ],
        staleTime: 5 * 60 * 1000, // 5 minutes
    });
}
/**
 * Component to display details for a completed transaction step
 */
function CompletedStepDetailCard({ status, preparedQuote, windowAdapter, onCopyToClipboard, }) {
    const theme = useCustomTheme();
    const { data: txInfo, isLoading } = useTransactionInfo(status, preparedQuote);
    if (isLoading) {
        return (_jsxs(Container, { flex: "column", gap: "sm", style: {
                backgroundColor: theme.colors.tertiaryBg,
                border: `1px solid ${theme.colors.borderColor}`,
                borderRadius: radius.sm,
                padding: spacing.md,
            }, children: [_jsx(Skeleton, { height: "30px" }), _jsx(Skeleton, { height: "30px" }), _jsx(Skeleton, { height: "30px" })] }));
    }
    if (!txInfo) {
        return null;
    }
    return (_jsxs(Container, { flex: "column", gap: "sm", style: {
            backgroundColor: theme.colors.tertiaryBg,
            border: `1px solid ${theme.colors.borderColor}`,
            borderRadius: radius.sm,
            padding: spacing.md,
        }, children: [_jsxs(Container, { flex: "row", gap: "sm", style: {
                    alignItems: "center",
                    justifyContent: "space-between",
                }, children: [_jsx(Text, { color: "primaryText", size: "sm", children: txInfo.label }), _jsx(Container, { style: {
                            backgroundColor: theme.colors.success,
                            borderRadius: radius.sm,
                            padding: `${spacing["3xs"]} ${spacing.xs}`,
                        }, children: _jsx(Text, { size: "xs", style: { color: theme.colors.primaryButtonText }, children: "COMPLETED" }) })] }), txInfo.amountPaid && (_jsxs(Container, { center: "y", flex: "row", style: { justifyContent: "space-between" }, children: [_jsx(Text, { color: "secondaryText", size: "sm", children: "Amount Paid" }), _jsx(Text, { color: "primaryText", size: "sm", children: txInfo.amountPaid })] })), txInfo.originChain && (_jsxs(Container, { center: "y", flex: "row", style: { justifyContent: "space-between" }, children: [_jsx(Text, { color: "secondaryText", size: "sm", children: "Origin Chain" }), _jsx(Text, { color: "primaryText", size: "sm", children: shorterChainName(txInfo.originChain.name) })] })), txInfo.amountReceived && (_jsxs(Container, { center: "y", flex: "row", style: { justifyContent: "space-between" }, children: [_jsx(Text, { color: "secondaryText", size: "sm", children: "Amount Received" }), _jsx(Text, { color: "primaryText", size: "sm", children: txInfo.amountReceived })] })), _jsxs(Container, { center: "y", flex: "row", style: { justifyContent: "space-between" }, children: [_jsx(Text, { color: "secondaryText", size: "sm", children: "Chain" }), _jsx(Text, { color: "primaryText", size: "sm", children: shorterChainName(txInfo.chain.name) })] }), _jsxs(Container, { center: "y", flex: "row", style: { justifyContent: "space-between" }, children: [_jsx(Text, { color: "secondaryText", size: "sm", children: txInfo.type === "paymentId" ? "Payment ID" : "Transaction Hash" }), _jsxs(Container, { flex: "row", gap: "sm", style: { alignItems: "center" }, children: [_jsx(Text, { color: "accentText", onClick: txInfo.type === "paymentId"
                                    ? () => onCopyToClipboard(txInfo.id)
                                    : () => {
                                        const explorer = txInfo.chain.explorers?.[0];
                                        if (explorer) {
                                            windowAdapter.open(formatExplorerTxUrl(explorer.url, txInfo.id));
                                        }
                                    }, size: "sm", style: {
                                    cursor: "pointer",
                                    fontFamily: "monospace",
                                }, children: shortenHex(txInfo.id) }), txInfo.type === "paymentId" ? (_jsx("button", { onClick: () => onCopyToClipboard(txInfo.id), style: {
                                    background: "none",
                                    border: "none",
                                    cursor: "pointer",
                                    padding: 0,
                                }, type: "button", children: _jsx(CopyIcon, { color: theme.colors.primaryText, height: iconSize.sm, width: iconSize.sm }) })) : null] })] })] }, txInfo.id));
}
export function PaymentReceipt({ preparedQuote, completedStatuses, onBack, windowAdapter, }) {
    // Copy to clipboard
    const copyToClipboard = useCallback(async (text) => {
        try {
            await navigator.clipboard.writeText(text);
            // Could add a toast notification here
        }
        catch (error) {
            console.warn("Failed to copy to clipboard:", error);
        }
    }, []);
    return (_jsxs(Container, { flex: "column", fullHeight: true, p: "lg", style: { maxHeight: "500px", minHeight: "250px", overflowY: "auto" }, children: [_jsx(ModalHeader, { onBack: onBack, title: "Payment Receipt" }), _jsx(Spacer, { y: "lg" }), _jsx(Container, { flex: "column", gap: "lg", children: _jsxs(Container, { flex: "column", gap: "md", children: [_jsx(Text, { color: "primaryText", size: "md", children: "Transactions" }), completedStatuses.map((status, index) => (_jsx(CompletedStepDetailCard, { onCopyToClipboard: copyToClipboard, preparedQuote: preparedQuote, status: status, windowAdapter: windowAdapter }, `${status.type}-${index}`)))] }) })] }));
}
//# sourceMappingURL=PaymentReceipt.js.map